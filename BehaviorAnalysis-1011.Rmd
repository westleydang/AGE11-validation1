---
title: "R Notebook"
output: html_notebook
---
# THESE ARE WITHOUT AGE 15 AND 16
 
# Load the data, process
- Question: Do I want the AGE 15 and AGE 16 in this analysis if I haven't put them through the macro yet? 
```{r}

# library(broom)
# library(reshape2)
# library(ggplot2)
# library(dplyr)
# library(tidyr)

library(grid)
library(gridExtra)
library(ggpubr)

fc_data = read.csv("AGE10-16 FC.csv", header=T) # source

fc_data0 = fc_data # back up
fc_data$ID = fc_data$Animal # rename to merge

animal_details = read.csv("animal_details4.csv")
fc_data = merge(fc_data, animal_details, by="ID") # merge

# OMIT THE 15 AND 16 SUBSETS
fc_data = fc_data %>%
  filter(!(SUBEXPT == '15A')) %>%
  filter(!(SUBEXPT == '16A'))

# cast components wide
fc_data2 = dcast(fc_data, ID + Group + Box ~ Component.Name, value.var = "Pct.Component.Time.Freezing")
fc_data2 = merge(fc_data2, animal_details, by="ID")
# 
# attach(fc_data)
# attach(fc_data2)


# change all the "OLD" to "AGED" for figures
aged = function(x) {
  x$EXPT = as.character(x$EXPT)
  x$EXPT[x$EXPT=='OLD'] = 'AGED'
  x$EXPT = as.factor(x$EXPT)
  x
}
total.weighted %>% aged()



# remove grid lines
remove_grids = function(x) {
  theme(panel.grid.minor = element_blank())
}

remove_legend = function(x) {
  theme(legend.position = "none")
}

```


# During FC
## Individual learning
```{r}


shock_only = fc_data %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(Component.Name == 'PRE' |
         Component.Name == 'POST1' |
         Component.Name == 'POST2' |
         Component.Name == 'POST3' |
         Component.Name == 'POST4' ) %>%
  mutate(Component.Name = case_when(
    Component.Name == "PRE" ~ 0,
    Component.Name == "POST1" ~ 1,
    Component.Name == "POST2" ~ 2,
    Component.Name == "POST3" ~ 3,
    Component.Name == "POST4" ~ 4
  ))

# individual animals after each shock
a1 = shock_only %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, color=EXPT, group=ID) +
  facet_wrap(~ID, nrow=4) + geom_point() + geom_line() + theme_minimal() +
  ggtitle(label="Freezing during fear learning", subtitle="After footshock, each individual") +
  xlab("Post-shock periods") + ylab("Percent Freezing")

as_ggplot(grid.arrange(a1)) + draw_plot_label("A", x=0, y=1)



```

## Pre-shock and post-shock
```{r}

# PRE SHOCK GRAPHS
c1 = fc_data %>%
  filter(Component.Name == "PRE") %>%
  ggplot() + aes(EXPT, Pct.Component.Time.Freezing, fill=EXPT) + 
  stat_summary(fun.y="mean", geom="bar") +
  stat_summary(fun.data="mean_se", geom="errorbar", width=0.2) +
  geom_point() + 
  theme_minimal() +
  ggtitle("Freezing during fear \nacquisition training",
          subtitle="Before footshocks") +
  xlab("Age groups") + ylab("Percent Freezing") + 
  theme(legend.position = "none") + 
  ylim(0,99)

# STATS
fc_data %>%
  filter(Component.Name == 'PRE') %>%
  wilcox.test(FREEZE ~ EXPT, data=.)

```


## individual animals after each shock, in one graph

```{r}
shock_only %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, color=EXPT, group=ID) +
  facet_wrap(~EXPT) + geom_point(alpha=0.5) + geom_line(alpha=0.5) + theme_minimal() +
  ggtitle("Individual freezing after each shock",
          subtitle="Shocked animals only") +
  xlab("Post-shock periods") + ylab("Percent Freezing") + 
  stat_summary(fun.data="mean_se", geom="errorbar", 
               color="black", aes(group=Component.Name,width=0.2)) +
  stat_summary(fun.y="mean", geom="point", 
               color="black", aes(group=Component.Name,width=0.2)) + 
  rx + theme(legend.position = "none")

# without the backgroind individuals
shock_only %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, color=EXPT) +
  facet_wrap(~EXPT) + theme_minimal() +
  ggtitle("Individual freezing after each shock",
          subtitle="Shocked animals only") +
  xlab("Post-shock periods") + ylab("Percent Freezing") + 
  stat_summary(fun.data="mean_se", geom="errorbar", 
               aes(group=Component.Name,width=0.2)) +
  stat_summary(fun.y="mean", geom="point", 
               aes(group=Component.Name,width=0.2)) + 
  theme(legend.position = "none")


# Average after each shock, by age
c2 = shock_only %>%
  group_by(EXPT, VALENCE, ID, Component.Name) %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=EXPT, color=EXPT) +
  stat_summary(fun.y = "mean", geom="line") +
  stat_summary(fun.data = "mean_se", geom="errorbar", aes(width=0.2)) +
  theme_minimal() + 
  ggtitle(label="\n ",
          subtitle="Freezing after each footshock") +
  xlab("Post-shock periods") + ylab("Percent Freezing") + rx +ylim(0,99)

as_ggplot(grid.arrange(c1, c2, nrow=1, widths=c(1,2))) +
  draw_plot_label(label = c("A", "B"), size = 15,
                  x = c(0, 0.33), y = c(1, 1))

# Check if the distribution is normal
shock_only %>%
  group_by(Component.Name) %>%
  do(tidy(shapiro.test(.$Pct.Total.Time.Freezing)))

# Stats for average after each shock, by age 2-way RM ANOVA
shock_only %>%
  # group_by(Component.Name) %>%
  do(tidy(aov(Pct.Component.Time.Freezing ~ EXPT*Component.Name + Error(ID/(Component.Name)), data = .))) %>%
  put_sig_scores()

summary(aov(Pct.Component.Time.Freezing ~ EXPT*Component.Name + Error(ID/(Component.Name)), data = shock_only))

summary(aov(Pct.Component.Time.Freezing ~ Component.Name + Error(ID/(Component.Name)), data = shock_only))

summary(lm(Pct.Component.Time.Freezing ~EXPT * Component.Name , data = shock_only %>% filter(!Component.Name=='0')))


```
### figure
```{r, fig.width=1.5, fig.height=1.25}

shock_only %>% 

  group_by(EXPT, VALENCE, ID, Component.Name) %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=EXPT, color=EXPT) +
  # ggtitle("Individual freezing after each shock",
          # subtitle="Shocked animals only") +
  theme_light() +
  # facet_wrap(~EXPT) +
  xlab("Post-shock periods") + ylab("Percent Freezing") + 
  stat_summary(fun.y="mean", geom="point", 
               aes(group=Component.Name,width=0.2)) + 
  stat_summary(fun.data="mean_se", geom="errorbar", 
               aes(group=Component.Name,width=0.2)) +
  theme(legend.position = "none") + scale_color_brewer(palette="Set1")

shock_only %>%  aged() %>%
  mutate(EXPT = factor(EXPT, levels=c('YOUNG', 'AGED'))) %>%
  group_by(EXPT, VALENCE, ID, Component.Name) %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=EXPT, color=EXPT) +
  stat_summary(fun.y = "mean", geom="line") +
  stat_summary(fun.data = "mean_se", geom="errorbar", aes(width=0.2)) +
  theme_minimal() + 
  xlab("Post-shock periods for SAA groups") + ylab("Freezing %") +
  theme(legend.position = "bottom") + scale_color_brewer(palette="Set1")

```


## What are anomalies in post-shock freezing?
```{r}
avg.psp = shock_only %>%
  filter((Component.Name == 'POST4')) %>%
  group_by(EXPT) %>%
  ddply(., .(ID, GROUP, EXPT), 
         summarize, 
         avg = mean(Pct.Component.Time.Freezing))

# Which animals are 1SD below the mean?
avg.psp[avg.psp$avg < mean(avg.psp$avg) - 1*sd(avg.psp$avg),]

```



## Trial correlations
```{r}
# Subset the shock only mice because that's what we're interested in


# Graph each component versus the final recall freezing

shock_only %>%
  filter(CONTEXT=='AA') %>%
  ggplot(aes(Pct.Component.Time.Freezing, FREEZE, color=EXPT)) + geom_point() + 
  facet_wrap(~Component.Name, scales="free") +
  stat_smooth(method=lm) + theme_minimal() + 
  ggtitle(paste("Recall vs Shock Trial correlations (shock animals only)", "AA")) +
  ylab("Freezing at final recall (4d)") +
  xlab("Freezing during training (each shock)") + 
  theme(legend.position="none")

shock_only %>%
  filter(CONTEXT=='AB') %>%
  ggplot(aes(Pct.Component.Time.Freezing, FREEZE, color=EXPT)) + geom_point() + 
  facet_wrap(~Component.Name, scales="free") +
  stat_smooth(method=lm) + theme_minimal() + 
  ggtitle(paste("Recall vs Shock Trial correlations (shock animals only)", "AB")) +
  ylab("Freezing at final recall (4d)") +
  xlab("Freezing during training (each shock)") 

as_ggplot(grid.arrange(e1, e2, nrow=1, widths=c(4,5))) + 
  draw_plot_label(label=c("A", "B"), x=c(0,0.44), y = c(1,1))


# Stats for the above, for AA vs AB
for (ctx in levels(unique(shock_only$CONTEXT))) {
  print(
    shock_only %>%
    filter(CONTEXT == ctx) %>%
      group_by(EXPT, CONTEXT, Component.Name) %>%
      do(tidy(lm(data=., formula = Pct.Component.Time.Freezing ~ FREEZE))) %>%
      mutate(p.value = p.adjust(p.value, method="bonferroni", n=8)) %>%
      mutate(sig = 
               case_when(
                 p.value < 0.0005 ~ "***",
                 p.value < 0.005 ~ "**", 
                 p.value < 0.05 ~ "*"
               ))
  )
}

# GET R VALUES
for (ctx in levels(unique(shock_only$CONTEXT))) {
  print(
    shock_only %>%
    filter(CONTEXT == ctx) %>%
      group_by(EXPT, CONTEXT, Component.Name) %>%
      do(tidy(summary((lm(data=., formula = Pct.Component.Time.Freezing ~ FREEZE)))$r.squared))
  )
}

```

## How do pre-shock periods look in Aged vs Young animals?
No difference using Wilcoxon Rank Sum (but 0.02 if using Welch's t-test)
```{r, out.width="20%"}

fc_data %>%
  filter(Component.Name == "PRE") %>%
  ggplot() + aes(EXPT, Pct.Component.Time.Freezing, fill=EXPT) + 
  stat_summary(fun.y="mean", geom="bar") +
  stat_summary(fun.data="mean_se", geom="errorbar", width=0.2) +
  geom_point() + 
  theme_minimal() +
  ggtitle("Freezing during context exploration (before initial shocks)",
          subtitle="Shocked animals only") +
  xlab("Age groups") + ylab("Percent Freezing")


# STATS
fc_data %>%
  filter(Component.Name == 'PRE') %>%
  wilcox.test(formula = FREEZE ~ EXPT, data=.)
```


# RC data, load and process

```{r}
rc_data = read.csv("AGE10-16 RC.csv", header = T)
rc_data0 = rc_data

rc_data$ID = rc_data$Animal


rc_data = merge(rc_data, animal_details, by="ID") # merge
rc_data = rc_data %>%
  filter(!(SUBEXPT == '15A')) %>%
  filter(!(SUBEXPT == '16A'))

# cast components wide
rc_data2 = dcast(rc_data, ID + Group + Box ~ Component.Name, value.var = "Pct.Component.Time.Freezing")
rc_data2 = merge(rc_data[1:13], animal_details, by="ID")

rc_avg = ddply(rc_data2,
               .(Experiment, EXPT, GROUP, VALENCE, CONTEXT, ID), 
               summarize, 
               avg.rc = mean(Pct.Component.Time.Freezing))

```

## Graph individual recall periods for shocked animals

```{r}

rc_shock = rc_data %>%
  filter(VALENCE=="SHOCK")

d1 = rc_shock %>%
  filter(CONTEXT == 'AA') %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=ID, color=EXPT) + 
  geom_line() + geom_point() + facet_wrap(EXPT~ID, nrow=3) + theme_minimal() + 
  ggtitle(paste("Shocked animals", "AA")) +
  xlab("Minute of recall trial (10 min total)") + ylab("Percent Freezing") + 
  theme(legend.position = "none") + rx

d2 = rc_shock %>%
  filter(CONTEXT == 'AB') %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=ID, color=EXPT) + 
  geom_line() + geom_point() + facet_wrap(EXPT~ID, nrow=3) + theme_minimal() + 
  ggtitle(paste("Shocked animals", "AB")) +
  xlab("Minute of recall trial (10 min total)") + ylab("Percent Freezing")+ 
  theme(legend.position = "none") + rx

as_ggplot(grid.arrange(d1, d2, nrow=1)) +
  draw_plot_label(label=c("A", "B"), x=c(0,0.5), y=c(1,1))

rc_shock %>%
  ggplot() + aes(Pct.Component.Time.Freezing) + geom_histogram(binwidth = 10)

```

## Average RC
```{r, fig.ratio=1}

rc_avg %>%
  ggplot() + aes(y = avg.rc, x = CONTEXT, fill=EXPT) + 
  facet_wrap(VALENCE~EXPT, nrow=1) +
  stat_summary(fun.y = "mean", geom="bar") +
  geom_point(position = position_dodge(width=1)) +
  stat_summary(fun.data="mean_se", geom="errorbar", color='black', width=0.2) +
  theme_minimal() + ylab("Freezing %") + xlab("Experimental Group") +
  ggtitle("Freezing behavior at recall (4d)")


rc_avg %>%
  filter(CONTEXT=='AA') %>%
  ggplot() + aes(y = avg.rc, x = CONTEXT, fill=EXPT) + 
  facet_wrap(VALENCE~EXPT, nrow=1) +
  stat_summary(fun.y = "mean", geom="bar") +
  # geom_point(position = position_dodge(width=1)) +
  stat_summary(fun.data="mean_se", geom="errorbar", color='black', width=0.2) +
  theme_minimal() + ylab("Freezing %") + xlab("Experimental Group") +
  ggtitle("Freezing behavior at recall (4d)")

```

### figure
```{r, fig.width=1.5, fig.height=1.5}
rc_avg %>%
  filter(CONTEXT=='AA') %>%
  aged() %>% mutate(EXPT = factor(EXPT, levels=c('YOUNG', 'AGED'))) %>%
  ggplot() + aes(y = avg.rc, x = EXPT, fill=EXPT) + 
  stat_summary(fun.y = "mean", geom="bar") +
  # geom_point(position = position_dodge(width=1)) +
  stat_summary(fun.data="mean_se", geom="errorbar", color='black', width=0.2) +
  theme_light() + ylab("Freezing %") + xlab("Experimental Group") +
  facet_wrap(~VALENCE) +
  xlab("SAA groups") +
  scale_fill_brewer(palette="Set1") + remove_legend() + remove_grids()


```

## Stats for RC
Young shock is not bimodal
```{r}
rc_avg %>%
  filter(VALENCE=='SHOCK') %>%
  # filter(EXPT=='OLD') %>%
  group_by(CONTEXT) %>%
  do(tidy(wilcox.test(data = ., avg.rc ~ EXPT)))

rc_avg %>%
  # group_by(EXPT) %>%
  filter(VALENCE=='SHOCK') %>%
  do(tidy(aov(., formula = avg.rc ~ EXPT * CONTEXT)))

# YOUNG SHOCK AA VS AB
rc_avg %>%
  filter(VALENCE=='SHOCK') %>%
  filter(EXPT=='YOUNG') %>%
  t.test(data=., avg.rc~ CONTEXT)

# YOUNG VS AGED SAA
rc_avg %>%
  filter(VALENCE=='SHOCK') %>%
  filter(CONTEXT=='AA') %>%
  t.test(data=., avg.rc~ EXPT)

# OLD SAA VS SAB
rc_avg %>%
  filter(VALENCE=='SHOCK') %>%
  filter(EXPT=='OLD') %>%
  t.test(data=., avg.rc~ CONTEXT)

merge(rc_avg, animal_details, by="ID") %>% mutate(diff = FREEZE - avg.rc) %>% 
  ggplot() + aes(as.factor(ID), diff) + geom_point() + rx

```



# MISCELLANEOUS

## What's with the first and last five minutes?
- I think there are some animals that have extinctions within the 10 min recall trial, so it might be interesting to separate them out and see what happens. 
- Here I will try to define them and add them separately

```{r}
# PLOT RAPID EXTINCTIONS
rc_data %>%
  mutate(half = ifelse(Component.Name < 6, "0-5 min", "5-10min")) %>%
  filter(VALENCE=='SHOCK') %>%
  group_by(EXPT, CONTEXT, ID, half) %>%
  summarize(percent.freezing = mean(Pct.Component.Time.Freezing)) %>%
  # spread(half, a) %>%
  # mutate(diff = first - second) %>%
  ggplot() + aes(half, percent.freezing, group=ID, color=EXPT) + geom_line() + geom_point() + 
  facet_wrap(CONTEXT~EXPT, ncol=4) +
  theme_minimal() +
  ggtitle("Freezing comparisons between first and second half of recall") +
  ylab("Percent Freezing")

# Determine whether the freezing went down between first and second half of the 10 minutes
# If the difference is more than 25% and goes down to less than 5%
ext.check = rc_data %>%
  mutate(half = ifelse(Component.Name < 6, "first", "second")) %>%
  group_by(EXPT, GROUP, ID, half) %>%
  summarize(percent.freezing = mean(Pct.Component.Time.Freezing)) %>%
  spread(half, percent.freezing) %>%
  mutate(was.ext = ifelse(((first - second) > 25) %% second < 5, 1, 0)) %>%
  group_by(ID) %>%
  select(c(ID, was.ext))
merge(rc_data, ext.check, by="ID")

```



## What are anomalies in post-shock freezing?
```{r}
avg.psp = shock_only %>%
  filter((Component.Name == 'POST4')) %>%
  group_by(EXPT) %>%
  ddply(., .(ID, GROUP, EXPT), 
         summarize, 
         avg = mean(Pct.Component.Time.Freezing))

# Which animals are 1SD below the mean?
avg.psp[avg.psp$avg < mean(avg.psp$avg) - 1*sd(avg.psp$avg),]


```
