---
title: "R Notebook"
output: html_notebook
---
# THESE ARE WITHOUT AGE 15 AND 16
 
# Load the data, process
- Question: Do I want the AGE 15 and AGE 16 in this analysis if I haven't put them through the macro yet? 
```{r}

# library(broom)
# library(reshape2)
# library(ggplot2)
# library(dplyr)
# library(tidyr)

fc_data = read.csv("AGE10-16 FC.csv", header=T) # source

fc_data0 = fc_data # back up
fc_data$ID = fc_data$Animal # rename to merge

animal_details = read.csv("animal_details4.csv")
fc_data = merge(fc_data, animal_details, by="ID") # merge

# OMIT THE 15 AND 16 SUBSETS
fc_data = fc_data %>%
  filter(!(SUBEXPT == '15A')) %>%
  filter(!(SUBEXPT == '16A'))


# cast components wide
fc_data2 = dcast(fc_data, ID + Group + Box ~ Component.Name, value.var = "Pct.Component.Time.Freezing")
fc_data2 = merge(fc_data2, animal_details, by="ID")
# 
# attach(fc_data)
# attach(fc_data2)


```
# During FC
## Graph the freezing after each shock
```{r}

shock_only = fc_data %>%
  filter(Component.Name == 'POST1' |
         Component.Name == 'POST2' |
         Component.Name == 'POST3' |
         Component.Name == 'POST4') %>%
  filter(VALENCE == 'SHOCK')

# individual animals after each shock
shock_only %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, color=EXPT, group=ID) +
  facet_wrap(~ID, nrow=4) + geom_point() + geom_line() + theme_minimal() +
  ggtitle("Individual freezing after each shock",
          subtitle="Shocked animals only") +
  xlab("Post-shock periods") + ylab("Percent Freezing") +
  rx


```

```{r}
# individual animals after each shock, in one graph
shock_only %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, color=EXPT, group=ID) +
  facet_wrap(~EXPT) + geom_point(alpha=0.5) + geom_line(alpha=0.5) + theme_minimal() +
  ggtitle("Individual freezing after each shock",
          subtitle="Shocked animals only") +
  xlab("Post-shock periods") + ylab("Percent Freezing") + 
  stat_summary(fun.data="mean_se", geom="errorbar", 
               color="black", aes(group=Component.Name,width=0.2)) +
  stat_summary(fun.y="mean", geom="point", 
               color="black", aes(group=Component.Name,width=0.2))

# Average after each shock, by age
shock_only %>%
  group_by(EXPT, VALENCE, ID, Component.Name) %>%
  ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=EXPT, color=EXPT) +
  stat_summary(fun.y = "mean", geom="line") +
  stat_summary(fun.data = "mean_se", geom="errorbar", aes(width=0.2)) +
  theme_classic() + 
  ggtitle("Average freezing after each shock",
          subtitle="Shocked animals only") +
  xlab("Post-shock periods") + ylab("Percent Freezing")

# Check if the distribution is normal
shock_only %>%
  group_by(Component.Name) %>%
  do(tidy(shapiro.test(.$Pct.Total.Time.Freezing)))

# Stats for average after each shock, by age
shock_only %>%
  group_by(Component.Name) %>%
  do(tidy(wilcox.test(data = ., Pct.Component.Time.Freezing ~ EXPT)))

```

## What are anomalies in post-shock freezing?
```{r}
avg.psp = shock_only %>%
  filter((Component.Name == 'POST4')) %>%
  group_by(EXPT) %>%
  ddply(., .(ID, GROUP, EXPT), 
         summarize, 
         avg = mean(Pct.Component.Time.Freezing))

# Which animals are 1SD below the mean?
avg.psp[avg.psp$avg < mean(avg.psp$avg) - 1*sd(avg.psp$avg),]



```



## Does each post-shock period predict the final recall (after 4d)?
```{r}
# Subset the shock only mice because that's what we're interested in


# Graph each component versus the final recall freezing
for (ctx in levels(unique(shock_only$CONTEXT))) {
  print(
    shock_only %>%
      filter(CONTEXT==ctx) %>%
      ggplot(aes(Pct.Component.Time.Freezing, FREEZE, color=EXPT)) + geom_point() + 
      facet_wrap(~Component.Name, scales="free") +
      stat_smooth(method=lm) + theme_minimal() + 
      ggtitle(paste("shock only", ctx)) +
      ylab("Freezing at final recall (4d)") +
      xlab("Freezing during training (each shock)")
  )
}

# Stats for the above, for AA vs AB
for (ctx in levels(unique(shock_only$CONTEXT))) {
  print(
    shock_only %>%
    filter(CONTEXT == ctx) %>%
      group_by(EXPT, CONTEXT, Component.Name) %>%
      do(tidy(lm(data=., formula = Pct.Component.Time.Freezing ~ FREEZE))) %>%
      filter(!term=="(Intercept)") %>%
      mutate(p.value = p.adjust(p.value, method="BH", n=8)) %>%
      mutate(sig = 
               case_when(
                 p.value < 0.0005 ~ "***",
                 p.value < 0.005 ~ "**", 
                 p.value < 0.05 ~ "*"
               ))
  )
}
```

## How do pre-shock periods look in Aged vs Young animals?
No difference using Wilcoxon Rank Sum (but 0.02 if using Welch's t-test)
```{r}

fc_data %>%
  filter(Component.Name == "PRE") %>%
  ggplot() + aes(EXPT, Pct.Component.Time.Freezing, color=EXPT) + 
  geom_violin() + geom_point() + 
  stat_summary(fun.y="mean", geom="point") +
  stat_summary(fun.data="mean_se", geom="errorbar", width=0.2) +
  theme_minimal() +
  ggtitle("Freezing during context exploration (before initial shocks)",
          subtitle="Shocked animals only") +
  xlab("Age groups") + ylab("Percent Freezing")

# STATS
fc_data %>%
  filter(Component.Name == 'PRE') %>%
  wilcox.test(FREEZE ~ EXPT, data=.)
```


# RC data, load and process

```{r}
rc_data = read.csv("AGE10-16 RC.csv", header = T)
rc_data0 = rc_data

rc_data$ID = rc_data$Animal
rc_data = merge(rc_data, animal_details, by="ID") # merge

# cast components wide
rc_data2 = dcast(rc_data, ID + Group + Box ~ Component.Name, value.var = "Pct.Component.Time.Freezing")
rc_data2 = merge(rc_data[1:13], animal_details, by="ID")

rc_avg = ddply(rc_data2,
               .(Experiment, EXPT, GROUP, VALENCE, CONTEXT, ID), 
               summarize, 
               avg.rc = mean(Pct.Component.Time.Freezing))



```

## Graph individual recall periods for shocked animals

```{r}

rc_shock = rc_data %>%
  filter(VALENCE=="SHOCK")

for (ctx in levels(unique(rc_shock$CONTEXT))) {
  print(
      rc_shock %>%
        filter(CONTEXT == ctx) %>%
        ggplot() + aes(Component.Name, Pct.Component.Time.Freezing, group=ID, color=EXPT) + 
        geom_line() + geom_point() + facet_wrap(EXPT~ID, nrow=3) + theme_minimal() + 
        ggtitle(paste("Shocked animals", ctx)) +
        xlab("Minute of recall trial (10 min total)") + ylab("Percent Freezing")
  )
}



```


```{r}

rc_avg %>%
  ggplot() + aes(y = avg.rc, x = CONTEXT, color=EXPT) +  geom_violin() +
  geom_point(position = position_dodge(width=1)) +
  facet_grid(EXPT~VALENCE) +
  stat_summary(fun.y = "mean", geom="point", color="black") +
  stat_summary(fun.data="mean_se", geom="errorbar", color='black', width=0.2) +
  theme_minimal() 


for (val in levels(unique(rc_avg$VALENCE))) {
  for (ctx in levels(unique(rc_avg$CONTEXT))) {
    print(
      rc_avg %>%
        filter(VALENCE == val) %>%
        filter(CONTEXT == ctx) %>%
        ggplot() + aes(x = avg.rc, fill=EXPT) + geom_density(alpha = 0.5) + 
        geom_vline(aes(xintercept=median(avg.rc)), linetype="dashed", size=1) + 
        theme_minimal() + ggtitle(paste(val, ctx, " animals, freezing score distribution")) +
        xlab("Average freezing score in 10 min recall") + xlim(0,100)
    )
  }
}

ggplot(rc_shock) + aes(Component.Name, Pct.Component.Time.Freezing, group=ID, color=EXPT) + 
  geom_line() + geom_point() + facet_wrap(EXPT~CONTEXT, ncol=2) + theme_minimal()

```

# Stats for RC
```{r}
rc_avg %>%
  filter(VALENCE=='SHOCK') %>%
  group_by(CONTEXT) %>%
  do(tidy(wilcox.test(data = ., avg.rc ~ EXPT)))


```



## What's with the first and last five minutes?
- I think there are some animals that have extinctions within the 10 min recall trial, so it might be interesting to separate them out and see what happens. 
- Here I will try to define them and add them separately

```{r}

rc_data %>%
  mutate(half = ifelse(Component.Name < 6, "0-5 min", "5-10min")) %>%
  group_by(EXPT, GROUP, ID, half) %>%
  summarize(percent.freezing = mean(Pct.Component.Time.Freezing)) %>%
  # spread(half, a) %>%
  # mutate(diff = first - second) %>%
  ggplot() + aes(half, percent.freezing, group=ID, color=EXPT) + geom_line() + geom_point() + 
  facet_wrap(GROUP~EXPT, ncol=4) +
  theme_minimal() +
  ggtitle("Freezing comparisons between first and second half of recall") +
  ylab("Percent Freezing")

# Determine whether the freezing went down between first and second half of the 10 minutes
# If the difference is more than 25% and goes down to less than 5%
ext.check = rc_data %>%
  mutate(half = ifelse(Component.Name < 6, "first", "second")) %>%
  group_by(EXPT, GROUP, ID, half) %>%
  summarize(percent.freezing = mean(Pct.Component.Time.Freezing)) %>%
  spread(half, percent.freezing) %>%
  mutate(was.ext = ifelse(((first - second) > 25) %% second < 5, 1, 0)) %>%
  group_by(ID) %>%
  select(c(ID, was.ext))
merge(rc_data, ext.check, by="ID")

```

Compare first 5 vs the whole 10 minutes
```{r}
  

```




