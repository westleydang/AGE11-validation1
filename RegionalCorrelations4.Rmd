---
title: "R Notebook"
output: html_notebook
---

# Inter-regional correlations - TOTAL
Conditions in this set of graphs:
- 1. 'Total' cells only
- 2. Density measures
- 3. Correlations use "complete.obs"
- 4. Ordering by "hclust"
- 5. Removed bad freezers from young group

```{r}
# detach("package:plyr", unload = T)
source("LoadLibs.R")
library(psych)
library(RColorBrewer)
knew.molten3 = knew.molten2 %>%
  filter(UNITS == "density") %>%
  filter(BRIGHTNESS == 'total')

cluster.method = "hclust"
use.method = "complete.obs"
corr.type = "pearson"

```

# Define functions for getting correlation tests, making heatmaps
```{r}
# DEFINE FUNCTION FOR GETTING CORRELATION TEST
get_corrtest = function(df) {
  data = df %>%
    mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
    ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
    dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 
  
  cor(data[,2:length(data)], data[,2:length(data)], use=use.method, method=corr.type)
  # corr.test(cor1)
}

# DEFINE FUNCTION FOR MAKING HEATMAP
make_heatmap = function(test.results, title) {
  # inputs the results from 'get_corrtest'
  # matrix = test.results$r
  heatmap(test.results, symm=T, col=brewer.pal(11,"RdBu"), main=title)
}

```

# ARCIHC
```{r}
# SUBSET FOR ARC ONLY
arc = knew.molten3 %>% filter(CHANNEL=='ArcIHC')
```


## Arc:: VALENCE
```{r, fig.width=8, fig.height=8}

# MAKE THE GRAPHS
for (val in levels(unique(knew.molten3$VALENCE))) {
  title = paste("all ArcIHC, ", val, " withlow freezers removed")
  a = arc %>%
    filter(VALENCE == val) %>%
    filter(!(EXPT =='YOUNG' & GROUP=='SAA' & FREEZE < 30)) %>% # removes young bad freezers
    get_corrtest() %>%
    make_heatmap(., title)
}

```
## Arc:: AGE x VALENCE
```{r, fig.width=8, fig.height=8}

# MAKE THE GRAPHS
for (val in levels(unique(knew.molten3$VALENCE))) {
  for (age in levels(unique(as.factor(knew.molten3$EXPT)))) {
    
    title = paste(age, val, "")
  
    a = arc %>%
      filter(VALENCE == val) %>%
      # filter(!(EXPT =='YOUNG' & GROUP=='SAA' & FREEZE < 30)) %>% # removes young bad freezers
      get_corrtest() %>%
      make_heatmap(., title)
  }
}

```





### All animals - compare each group

```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 
b = corr.test(a[,2:67])
heatmap(b$r, symm=T, col=brewer.pal(11,"RdBu"), main="correlation -  all shock arc")
heatmap(b$p, symm=T, col=rev(brewer.pal(3,"Reds")), main="p-value (Holm) - all shock arc")

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="shock AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="shock AB")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="ctx AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="ctx AB")


```

## OL 
### Old vs Young

```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(EXPT == 'YOUNG') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all young")

a = knew.molten3 %>%
  filter(EXPT == 'OLD') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all old")

```

```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(CONTEXT == 'AA') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all AA")

a = knew.molten3 %>%
  filter(CONTEXT == 'AB') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all AB")

```

```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all shock ol")

a = knew.molten3 %>%
  filter(VALENCE == 'CONTEXT') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all context ol")

```

### All animals - Compare each group


```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main=" shock AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main=" shock AB")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main=" ctx AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main=" ctx AB")


```


## H2BGFP

```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all shock h2b")

a = knew.molten3 %>%
  filter(VALENCE == 'CONTEXT') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="all context h2b")

```
### All animals - Compare each group


```{r, fig.width=8, fig.height=8}

a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="shock AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="shock AB")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="ctx AA")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) 

cor1 = cor(a[,2:67], a[,2:67], use=use.method, method=corr.type)
heatmap(cor1, symm=T, Rowv=hr$order, col=brewer.pal(11,"RdBu"), main="ctx AB")


```


