---
title: "R Notebook"
output: html_notebook
---

# Inter-system correlations - TOTAL
Conditions in this set of graphs:
- 1. 'Total' cells only
- 2. Density measures
- 3. Correlations use "complete.obs"
- 4. Ordering by "hclust"
- 5. Removed bad freezers from young group

```{r, message=F}
# source("LoadLibs.R")

cluster.method = "alphabet"
use.method = "complete.obs"
corr.type="pearson"

```

# Define functions for getting correlation tests, making heatmaps
```{r}
# DEFINE FUNCTION FOR GETTING CORRELATION TEST
get_corrtest_sys = function(df) {
  data = df %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(CHANNEL, ID), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  
  # IMPUTE MISSING VALUES 
  data = complete(mice(data, m=5, seed=500))
  
  # rcorr = cor(data[,2:length(data)], data[,2:length(data)], use=use.method, method=corr.type)
    rcorr = rcorr(as.matrix(data[,2:length(data)]), type=corr.type)
    # return(list(data=data, rcorr=rcorr))
    return(rcorr)
}


# DEFINE FUNCTION FOR MAKING HEATMAP
make_heatmap = function(test.results, title) {
  # inputs the results from 'get_corrtest'
  # matrix = test.results$r
  heatmap.2(test.results, symm=T, 
            col=rev(brewer.pal(11,"RdBu")), main=title, 
            trace="none", revC=T, margins=c(10,10),
            key=T, scale="none"
            )
}


# DEFINE FUNCTION FOR MAKING HEATMAP FOR NUMBER ANIMALS
make_heatmap2 = function(test.results, title) {
  # inputs the results from 'get_corrtest'
  # matrix = test.results$r
  # heatmap(test.results, symm=T, col=heat.colors, main=title)
  
  p = p.adjust(test.results$P, "fdr")
  
  corrplot(test.results$r, title=title, insig="blank", p.mat=test.results$P, sig.level=0.05,
           order=cluster.method, method="color", mar=c(0,0,1,0),
           diag=T, tl.pos = "l")
}
```


# Define Corr. Comparisons
```{r}
# DEFINE MATRIX FOR MAKING GENERAL COMPARISONS
compare_matrix_r = function(x,y, namex, namey) {
  
  # MAKE COR MATS
  make_heatmap2(x, namex)
  make_heatmap2(y, namey)

  # print n
  print(paste(c("n1=", min(x$n))))
  
  print(paste(c("n2=", min(y$n))))
  
  # STEIGER TEST STATS
  print(
    cortest.normal(R1 = x$r,
                 R2 = y$r,
                 n1 = min(x$n),
                 n2 = min(y$n))
  )
  
  print(
    cortest.mat(R1 = x$r,
                 R2 = y$r,
                 n1 = min(x$n),
                 n2 = min(y$n))
  )
    
  # PRINT DIFFERENCE MATRIX
  yx = y$r - x$r
  title = paste("Difference (", namey, " - ", namex, ")")
  corrplot(yx, title=title, order=cluster.method, method="color", 
           mar=c(0,0,1,0), diag=T, tl.pos = "l") 
}


```

# Define PCA function
```{r}
get_data_matrix = function(df) {
  data = df %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(System), transform, z = scale(wm)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean, .drop=T) 
  data
}

get_pca = function(df, dfname) {
  
  adm = df %>% get_data_matrix()
  adm[is.na(adm)] = 0
  rownames(adm) = adm$ID # make ID the rownames
  adm = adm %>% select(2:16) # remove ID
  pr = prcomp(na.omit(adm), scale=T)
  print(summary(pr))
  print(biplot(pr))
  
  
  plot(pr$x[,1], pr$x[,2]) # 
  pr.var = pr$sdev^2 # get variance by squaring eigenvalues
  pr.var.pct = round(pr.var/(sum(pr.var)) * 100, 1) # get variance %
  
  print(
  data.frame(name = paste(1:length(pr.var.pct)), percent = pr.var.pct) %>%
    ggplot() + geom_bar(stat="identity", show.legend = F) + aes(sort(as.numeric(name), decreasing=F), percent, fill=name) + 
    ggtitle(paste(dfname, "- Scree plot")) + 
    xlab("Principal Component") + ylab("% variance explained") + 
    theme_minimal()
)
  
  
  pr.data = data.frame(Sample=rownames(pr$x), X = pr$x[,1], Y = pr$x[,2])
  pr.data$ID = pr.data$Sample
  
  pr.data=merge(pr.data, animal_details[2:length(animal_details)])
  pr.data$GRAIN = paste(pr.data$GROUP, pr.data$VALENCE)
  
  
  # PRINT SOME GRAPHS
  
  print(
    ggplot(pr.data) + aes(X, Y, label=GRAIN,color=GRAIN) + geom_point() + theme_minimal()  + stat_ellipse() + facet_wrap(~EXPT) +
    xlab("PC1") + ylab("PC2") + ggtitle(paste(dfname,"PCA by experimental group"))
  )
  
  print(
    ggplot(pr.data) + aes(X, Y, label=FREEZE,color=VALENCE) + geom_text() + theme_minimal() + stat_ellipse() +
      xlab("PC1") + ylab("PC2") + ggtitle(paste(dfname, "Component space, by shock/context, labeled freezing score"))
  )
    
  print(
    ggplot(pr.data) + aes(X, Y, label=FREEZE,color=EXPT) + geom_text() + theme_minimal() + stat_ellipse() + 
      xlab("PC1") + ylab("PC2") + ggtitle(paste(dfname, "Component space, by young/old, labeled freezing score"))
  )
  
  pr.load = pr$rotation[,1] # PC1
  sys.scores = abs(pr.load)
  sys.scores.ranked = sort(sys.scores, decreasing=T)
  as.matrix(pr.load[names(sys.scores.ranked)])

}


```


# ARCIHC
```{r}
# SUBSET FOR ARC ONLY
arc = sys.weighted %>% filter(CHANNEL=='ArcIHC') 


get_pca(arc, "ArcIHC")
```

### Arc::VALENCE stats = ns

Is there a difference between odd/even animals? That should be a control.

Fuck my life. 

```{r}
arcodd = arc %>%
  filter((ID %%2) == T) %>%
  get_corrtest_sys()

arceven = arc %>%
  filter((ID%%2) ==F) %>%
  get_corrtest_sys()

compare_matrix_r(arcodd, arceven, "odd", "even")


```

```{r}

av1 = arc %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys()

av2 = arc %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys()

compare_matrix_r(av1, av2, "context", "shock")




```

### Arc::EXPT = ***
```{r}

# Get Z dist of CONTEXT
arc.age1 = arc %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys() 

arc.age2 = arc %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys() 

compare_matrix_r(arc.age1, arc.age2, "young", "old")




```



## Arc - EXPT:VALENCE Mantel test
```{r}

arc.ys = arc %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

arc.yc = arc %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

arc.os = arc %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

arc.oc = arc %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

```


### Arc Young CTX vs SHK = ***
```{r, fig.height=1, fig.width=2}

compare_matrix_r(arc.yc, arc.ys, "youngCTX", "youngSHK")


```

### Arc Old CTX vs SHK = ns
```{r, fig.height=1, fig.width=2}

compare_matrix_r(arc.oc, arc.os, "oldCTX", "oldSHK")
```




# H2BGFP
```{r}
# SUBSET FOR ARC ONLY
gfp = sys.weighted %>% filter(CHANNEL=='H2BGFP') 

get_pca(gfp, "H2BGFP")
```

### GFP::VALENCE stats = ***
```{r}

# Get Z dist of CONTEXT
gv1 = gfp %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys()

gv2 = gfp %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys()

compare_matrix_r(gv1, gv2, "context", "shock")


```


### GFP::EXPT = ns
```{r}

# Get Z dist of CONTEXT
gfp.age1 = gfp %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys() 

gfp.age2 = gfp %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys()

compare_matrix_r(gfp.age1, gfp.age2, "young", "old")
```



## GFP - EXPT:VALENCE Mantel test
```{r}

gfp.ys = gfp %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys() %>%
  as.dist()

gfp.yc = gfp %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys() %>%
  as.dist()

gfp.os = gfp %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys() %>%
  as.dist()

gfp.oc = gfp %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys() %>%
  as.dist()

```


### gfp Young CTX vs SHK = *
```{r}

mantel.rtest(gfp.ys, gfp.yc)
```

### gfp Old CTX vs SHK = **
```{r}

mantel.rtest(gfp.os, gfp.oc)
```



# NormOL
```{r}
# SUBSET FOR ARC ONLY
nol = sys.weighted %>% filter(CHANNEL=='NormOL')
get_pca(nol, "NormOL")
```


### NormOL::VALENCE stats = **
```{r}

# Get Z dist of CONTEXT
nv1 = nol %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys() 

nv2 = nol %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys() 

compare_matrix_r(nv1, nv2, "context", "shock")

```


### NormOL::EXPT = ns
```{r}

# Get Z dist of CONTEXT
nol.age1 = nol %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys()

nol.age2 = nol %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys()

compare_matrix_r(nol.age1, nol.age2, "young", "old")

```

## NormOL - EXPT:VALENCE Mantel test
```{r}

nol.ys = nol %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys() 

nol.yc = nol %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

nol.os = nol %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

nol.oc = nol %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

```


### NormOL Young CTX vs SHK = **
```{r}

compare_matrix_r(nol.ys, nol.yc, "shock", "context")
```

### NormOL Old CTX vs SHK = **
```{r}

compare_matrix_r(nol.os, nol.oc, "shock", "context")
```



```{r}

```

