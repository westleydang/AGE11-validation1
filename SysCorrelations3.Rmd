---
title: "R Notebook"
output: html_notebook
---

# Inter-system correlations - TOTAL
Conditions in this set of graphs:
- 1. 'Total' cells only
- 2. Density measures
- 3. Correlations use "complete.obs"
- 4. Ordering by "hclust"
- 5. Removed bad freezers from young group

```{r, message=F}
# source("LoadLibs.R")

require(MASS)
library(ade4)
library(RColorBrewer)
library(gplots)

cluster.method = "hclust"
use.method = "complete.obs"
corr.type="pearson"

```

# Define function for changing AGE 10 to YOUNG
```{r}

change_expt_names = function(df) {
  df %>%
    mutate(EXPT = ifelse(EXPT == "AGE 10", "YOUNG", "OLD"))
}

```

# Define functions for getting correlation tests, making heatmaps
```{r}
# DEFINE FUNCTION FOR GETTING CORRELATION TEST
get_corrtest_sys = function(df) {
  data = df %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(CHANNEL, ID), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  
  # remove spaces
  names(data) = gsub(" ", "_", names(data))
  names(data) = gsub("-", ".", names(data))
  
  # IMPUTE MISSING VALUES 
  data = complete(mice(data, m=5, seed=500))
  
  # rcorr = cor(data[,2:length(data)], data[,2:length(data)], use=use.method, method=corr.type)
    rcorr = rcorr(as.matrix(data[,2:length(data)]), type=corr.type)
    # return(list(data=data, rcorr=rcorr))
    return(rcorr)
}


# DEFINE FUNCTION FOR MAKING HEATMAP
make_heatmap = function(test.results, title) {
  # inputs the results from 'get_corrtest'
  # matrix = test.results$r
  heatmap.2(test.results, symm=T, 
            col=rev(brewer.pal(11,"RdBu")), main=title, 
            trace="none", revC=T, margins=c(10,10),
            key=T, scale="none"
            )
}


# DEFINE FUNCTION FOR MAKING HEATMAP FOR NUMBER ANIMALS
make_heatmap2 = function(test.results, title) {
  # inputs the results from 'get_corrtest'
  # matrix = test.results$r
  # heatmap(test.results, symm=T, col=heat.colors, main=title)

  
  corrplot(test.results$r, title=title, p.mat=test.results$P, insig="blank",pch="*", sig.level=0.05,
           order=cluster.method, method="color", mar=c(0,0,1,0), pch.col="white",pch.cex = 2,
           diag=T)
}

```


# Define Corr. Comparisons
```{r}


flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}

compare_sigs = function(mat1, mat2) {

}

# DEFINE MATRIX FOR MAKING GENERAL COMPARISONS
compare_matrix_r = function(x,y, namex, namey) {
  
  # MAKE COR MATS
  make_heatmap2(x, namex)
  make_heatmap2(y, namey)


  # print n
  print(paste(c("n1=", min(x$n))))
  print(paste(c("n2=", min(y$n))))
  
  # STEIGER TEST STATS
  print(
    cortest.normal(R1 = x$r,
                 R2 = y$r,
                 n1 = min(x$n),
                 n2 = min(y$n))
  )
  
  # MANTEL TEST
  print(
    mantel.rtest(as.dist(x$r), as.dist(y$r))
  )
  
  # print(
  #   cortest.mat(R1 = x$r,
  #                R2 = y$r,
  #                n1 = min(x$n),
  #                n2 = min(y$n))
  # )
    
  # PRINT DIFFERENCE MATRIX
  yx = y$r - x$r
  title = paste("Difference (", namey, " - ", namex, ")")
  # corrplot(yx, title=title, order=cluster.method, method="color", 
  #          mar=c(0,0,1,0), diag=T, tl.pos = "l") 
  
  
  # PRINT T-TEST PAIRED
  x.vector = as.vector(x$r[lower.tri(x$r, diag=F)])
  y.vector = as.vector(y$r[lower.tri(y$r, diag=F)])
  # print(t.test(fisherz(x.vector), 
  #            fisherz(y.vector), 
  #            paired=T))
  
    # PLOT DISTRIBUTION OF R VALUES
  df = data.frame(var = c(rep(namex, length(x.vector)), rep(namey, length(y.vector))), 
               values = c(x.vector, y.vector)) 
  print(
    df %>%
      ggplot() + aes(values, group=var, fill=var) + geom_density(alpha=0.5) + 
      theme_minimal() + xlim(-1,1) + xlab("Pearson's R") +
      ylab("Frequency") 
      # ggtitle("Distribution of R values")
  )
    print(
    df %>%
      mutate(z = fisherz(as.vector(values))) %>%
      ggplot() + aes(var, z) +
      stat_summary(fun.y = "mean", geom="bar") +
      stat_summary(fun.data = "mean_se", geom="errorbar") +
      theme_minimal())
  
  flat1 = flattenCorrMatrix(x$r, x$P) %>% mutate(comp = paste(row, column))
  flat2 = flattenCorrMatrix(y$r, y$P) %>% mutate(comp = paste(row, column))
  flat.both = merge(flat1, flat2 %>% dplyr::select(cor, p, comp), by="comp")
  flat.both = flat.both %>% mutate(p.delta = case_when(
    p.x < 0.05 & p.y < 0.05 ~ "s-s",
    p.x < 0.05 & p.y > 0.05 ~ "s-ns",
    p.x > 0.05 & p.y < 0.05 ~ "ns-s",
    p.x > 0.05 & p.y > 0.05 ~ "ns-ns"),
    p.sign = case_when(
      cor.x > 0 & cor.y > 0 ~ "++",
      cor.x > 0 & cor.y < 0 ~ "+-",
      cor.x < 0 & cor.y < 0 ~ "--",
      cor.x < 0 & cor.y > 0 ~ "-+"
    )
  )
  results = summary(as.factor(flat.both$p.delta))
  results2 = summary(as.factor(flat.both$p.sign))
  
  barplot(results, main=paste("Change: ", namex, "to", namey))
  barplot(results2, main=paste("Change sign: ", namex, "to", namey))
  
}


```

# Define MANOVA function
```{r}

get_manova = function(df) {
  data.manova = df %>% dcast(ID + EXPT + GROUP + VALENCE + CONTEXT ~ System, value.var = "boxed")
  data.manova = complete(mice(data.manova, m=5, seed=25))
  response = as.matrix((data.manova[,6:18]))
  g = as.vector(data.manova[,"GROUP"])
  e = as.vector(data.manova[,"EXPT"])
  v = as.vector(data.manova[,"VALENCE"])
  c = as.vector(data.manova[,"CONTEXT"])
  m = manova(response ~ e * v * c)
  summary(m, test="Hotelling")
  
}


```


# Define PCA function
```{r}
get_data_matrix = function(df) {
  data = df %>%
    ddply(.(System), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  data
}

get_pca = function(df, dfname) {
  
  adm = df %>% get_data_matrix()
    
  # remove spaces? 
names(adm) = gsub(" ", "_", names(adm))
names(adm) = gsub("-", ".", names(adm))
  adm = mice::complete(mice::mice(adm, m=5, seed=10))
  rownames(adm) = adm$ID # make ID the rownames

  adm = adm %>% dplyr::select(2:length(adm)) # remove ID
  pr = prcomp(na.omit(adm), scale=T)
  print(summary(pr))
  print(biplot(pr))
  
  plot(pr$x[,1], pr$x[,2]) # 
  pr.var = pr$sdev^2 # get variance by squaring eigenvalues
  pr.var.pct = round(pr.var/(sum(pr.var)) * 100, 1) # get variance %
  
  print(
  data.frame(name = paste(1:length(pr.var.pct)), percent = pr.var.pct) %>%
    ggplot() + geom_bar(stat="identity", show.legend = F) + aes(sort(as.numeric(name), decreasing=F), percent, fill=name) + 
    ggtitle(paste(dfname, "- Scree plot")) + 
    xlab("Principal Component") + ylab("% variance explained") + 
    theme_minimal()
)
  
  pr.data = data.frame(Sample=rownames(pr$x), X = pr$x[,1], Y = pr$x[,1])
  pr.data$ID = pr.data$Sample
  
  pr.data=merge(pr.data, animal_details[2:length(animal_details)])
  pr.data$GRAIN = paste(pr.data$GROUP, pr.data$VALENCE)
  
  
  # PRINT SOME GRAPHS
  print(
    ggplot(pr.data) + 
      aes(X, Y, label=GRAIN, color=GRAIN) + 
      geom_point() + 
      theme_minimal()  + 
      stat_ellipse() + 
      facet_wrap(~EXPT) +
      xlab("PC1") + ylab("PC2") + 
      ggtitle(paste(dfname,"PCA by experimental group")) +
      geom_text()
  )
  
  print(
    ggplot(pr.data) + aes(X, Y, label=FREEZE,color=VALENCE) + geom_text() + theme_minimal() + stat_ellipse() +
      xlab("PC1") + ylab("PC2") + ggtitle(paste(dfname, "Component space, by shock/context, labeled freezing score"))
  )
    
  print(
    ggplot(pr.data) + aes(X, Y, label=FREEZE,color=VALENCE) + geom_text(aes(X,Y, label=VALENCE)) + theme_minimal() + 
      xlab("PC1") + ylab("PC2") + ggtitle(paste(dfname, "Component space, by young/old, labeled freezing score")) + 
      facet_wrap(~EXPT)
  )
  
  pr.load = pr$rotation[,1] # PC1
  sys.scores = abs(pr.load)
  sys.scores.ranked = sort(sys.scores, decreasing=T)
  as.matrix(pr.load[names(sys.scores.ranked)])

}


```


# Define LDA function
```{r}
# LDA DEFINE FUNCTION
get_lda = function(df, dfname) {
  data.for.lda = df %>%
  ddply(.(ID), transform, z = scale(weighted)) %>%
  dcast(ID ~ System, value.var="z", fun.aggregate = mean) 

  data.for.lda = merge(data.for.lda, animal_details %>% 
                         
   mutate(EXPT = ifelse(EXPT == "AGE 10", "YOUNG", "OLD")) %>%
   mutate(GRAIN = paste(EXPT, VALENCE)) %>% dplyr::select(ID, GRAIN), by="ID")
  
  # remove spaces? 
  names(data.for.lda) = gsub(" ", "_", names(data.for.lda))
  names(data.for.lda) = gsub("-", ".", names(data.for.lda))
  
  # impute missing data
  data.for.lda = mice::complete(mice(data.for.lda, m=5, seed=25))

  # lda
  r <- lda(formula = GRAIN ~ ., 
           data = data.for.lda[,2:ncol(data.for.lda)], 
           prior = c(1,1,1,1)/4)
  
  # get lda scalings/coefs
  dl <- data.frame(varnames=rownames(coef(r)), coef(r)) 
  dl$length <- with(dl, sqrt(LD1^2+LD2^2))
  dl = dl %>% mutate(pct.LD1 = 100*abs(LD1)/sum(abs(LD1))) %>% arrange(pct.LD1)
  print(dl)
  
  print(
      ggplot(dl) + aes(reorder(varnames, as.numeric(pct.LD1)), as.numeric(pct.LD1)) + geom_bar(stat="identity") + rx +
        coord_flip() + theme_light() + xlab("System") + ylab("Proportion of variance") + 
        theme(text = element_text(size=20))
  )

  
  scaling_text = geom_text(
    data = dl,
    aes(
      x = LD1,
      y = LD2,
      label = varnames,
      # linetype = NULL,
      alpha = length
      # position = "identity"
    ),
    size = 4,
    vjust = .5,
    hjust = 0,
    color = "red"
  )
  
  
  scaling_arrows =  geom_segment(
    data = dl,
    aes(
      x = 0,
      y = 0,
      xend = LD1,
      yend = LD2,
      # linetype = NULL,
      alpha = length
    ),
    arrow = arrow(length = unit(0.1, "mm")),
    color = "red"
  ) 
  
  
  prop = r$svd^2/sum(r$svd^2)
  
  plda = predict(object = r, # predictions
                 newdata = data.for.lda)
  plda$class
  
  
  dataset = data.frame(GRAIN = data.for.lda[,"GRAIN"],
                       lda = plda$x) 
  
  p1 <- ggplot(dataset) + geom_point(aes(lda.LD1, lda.LD2, colour = GRAIN, shape = GRAIN), size = 2.5) + 
    labs(x = paste("LD1 (", round(100*(prop[1])/sum(prop),2), "%)", sep=""),
         y = paste("LD2 (", round(100*(prop[2])/sum(prop),2), "%)", sep="")) +
    
    # ggtitle(paste(dfname, "LDA for each age and conditioning")) +
    theme_minimal() + 
    stat_ellipse(aes(x=lda.LD1, y=lda.LD2, fill = GRAIN), alpha = 0.2, geom = "polygon") +
    theme(legend.position="right", legend.title=element_text(colour="white")) + 
    scaling_text + scaling_arrows + ggtitle(paste("LDA for ", dfname))
  
    p2 <- ggplot(dataset) + geom_point(aes(lda.LD1, lda.LD3, colour = GRAIN, shape = GRAIN), size = 2.5) + 
    labs(x = paste("LD1 (", round(100*(prop[1])/sum(prop),2), "%)", sep=""),
         y = paste("LD3 (", round(100*(prop[3])/sum(prop),2), "%)", sep="")) +
    theme_minimal() + 
    stat_ellipse(aes(x=lda.LD1, y=lda.LD3, fill = GRAIN), alpha = 0.2, geom = "polygon") +
    theme(legend.position="right", legend.title=element_text(colour="white")) + 
    scaling_text + scaling_arrows
    
      p3 <- ggplot(dataset) + geom_point(aes(lda.LD3, lda.LD2, colour = GRAIN, shape = GRAIN), size = 2.5) + 
    labs(x = paste("LD3 (", round(100*(prop[3])/sum(prop),2), "%)", sep=""),
         y = paste("LD2 (", round(100*(prop[2])/sum(prop),2), "%)", sep="")) +
    
    # ggtitle(paste(dfname, "LDA for each age and conditioning")) +
    theme_minimal() + 
    stat_ellipse(aes(x=lda.LD3, y=lda.LD2, fill = GRAIN), alpha = 0.2, geom = "polygon") +
    theme(legend.position="right", legend.title=element_text(colour="white")) + 
    scaling_text + scaling_arrows
  
  print(p1)
  print(p2)
  print(p3)
  
}



```


# ARCIHC
```{r}
# SUBSET FOR ARC ONLY
arc = sys.weighted %>% filter(CHANNEL=='ArcIHC')  



# get_pca(arc, "ArcIHC")
get_lda(arc, "ArcIHC")
# get_manova(arc)
```

# All heatmap ArcIHC
```{r}

arc.hm = arc %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(CHANNEL, ID), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  # ggplot() +aes(as.factor(ID), System, z=z, fill=z) + geom_tile() + rx
# remove spaces? 
  names(arc.hm) = gsub(" ", "_", names(arc.hm))
  names(arc.hm) = gsub("-", ".", names(arc.hm))
  
  # impute missing data
  arc.hm = mice::complete(mice(arc.hm, m=5, seed=25))
rownames(arc.hm) = arc.hm$ID  

ahm.cor = cor(arc.hm[2:length(arc.hm)])
network=graph_from_adjacency_matrix( ahm.cor, weighted=T, mode="undirected", diag=F)
layout_in_circle(network)
plot(network)

heatmap.2(as.matrix(arc.hm[2:length(arc.hm)]), trace="none", hclustfun = hclust,
          col=(brewer.pal(11,"RdBu")),margins=c(10,10), main="ArcIHC, scaled within animal")

```


### Control ODD vs EVEN
Is there a difference between odd/even animals? That should be a control.
```{r}
arcodd = arc %>%
  filter((ID %%2) == T) %>%
  get_corrtest_sys()

arceven = arc %>%
  filter((ID%%2) == F) %>%
  get_corrtest_sys()

compare_matrix_r(arcodd, arceven, "odd", "even")

```
### Arc::VALENCE stats

```{r, message=F}

av1 = arc %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys()

av2 = arc %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys()

compare_matrix_r(av1, av2, "Context", "Shock")
# 
# hotelling.test(av1$r, av2$r)

```

### Arc::EXPT
```{r}
arc.age1 = arc %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys() 

arc.age2 = arc %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys() 

compare_matrix_r(arc.age1, arc.age2, "Young", "Old")

```


### Arc::CONTEXT 
```{r}

arc.c1 = arc %>%
  filter(CONTEXT == 'AB') %>%
  get_corrtest_sys() 

arc.c2 = arc %>%
  filter(CONTEXT == 'AA') %>%
  get_corrtest_sys() 

compare_matrix_r(arc.c1, arc.c2, "AB", "AA")

```

## Arc - EXPT:VALENCE
```{r, message=F}

arc.ys = arc %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

arc.yc = arc %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

arc.os = arc %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

arc.oc = arc %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

```


### Arc Young-CTX vs Young-SHK
```{r}

compare_matrix_r(arc.yc, arc.ys, "Young CTX", "Young SHK")

```

### Arc OldCTX vs OldSHK
```{r}

compare_matrix_r(arc.oc, arc.os, "Old CTX", "Old SHK")
```

### Arc OLD CTX vs YOUNG CTX
```{r}

compare_matrix_r(arc.yc, arc.oc, "Young CTX", "Old CTX")
```
### Arc OLD SHK vs YOUNG SHK
```{r}

compare_matrix_r(arc.ys, arc.os, "Young SHK", "Old SHK")
```


# H2BGFP
```{r}
# SUBSET FOR ARC ONLY
gfp = sys.weighted %>% filter(CHANNEL=='H2BGFP')

# get_pca(gfp, "H2BGFP")
# get_lda(gfp, "H2BGFP")
# get_manova(gfp)
```

# H2BGFP Heatmap
```{r}

gfp.hm = gfp %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(CHANNEL, ID), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  # ggplot() +aes(as.factor(ID), System, z=z, fill=z) + geom_tile() + rx
# remove spaces? 
  names(gfp.hm) = gsub(" ", "_", names(gfp.hm))
  names(gfp.hm) = gsub("-", ".", names(gfp.hm))
  
  # impute missing data
  arc.hm = mice::complete(mice(gfp.hm, m=5, seed=25))
rownames(gfp.hm) = gfp.hm$ID  


heatmap.2(as.matrix(gfp.hm[2:length(gfp.hm)]), trace="none", hclustfun = hclust,
          col=(brewer.pal(11,"RdBu")),margins=c(10,10), main="H2BGFP, scaled within animal")
```

## LDA
```{r, fig.height=2, fig.width=3.5}

get_lda(gfp, "H2BGFP")
```


### Control ODD vs EVEN
```{r}
godd = gfp %>%
  filter((ID %% 2) == T) %>%
  get_corrtest_sys()

geven = gfp %>%
  filter((ID%%2) == F) %>%
  get_corrtest_sys()

compare_matrix_r(godd, geven, "odd", "even")
```


### GFP::VALENCE stats
```{r}

gv1 = gfp %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys()

gv2 = gfp %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys()

compare_matrix_r(gv1, gv2, "context", "shock")

```


### GFP::CONTEXT
```{r}

gfp.c1 = gfp %>%
  filter(EXPT == 'AA') %>%
  get_corrtest_sys() 

gfp.c2 = gfp %>%
  filter(EXPT == 'AB') %>%
  get_corrtest_sys()

compare_matrix_r(gfp.c1, gfp.c2, "AA", "AB")
```


### GFP::EXPT 
```{r}

gfp.age1 = gfp %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys() 

gfp.age2 = gfp %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys()

compare_matrix_r(gfp.age1, gfp.age2, "young", "old")
```



## GFP - EXPT:VALENCE
```{r}

gfp.ys = gfp %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

gfp.yc = gfp %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

gfp.os = gfp %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

gfp.oc = gfp %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

```


### gfp Young CTX vs SHK 
```{r}
compare_matrix_r(gfp.ys, gfp.yc, "ySHK", "yCTX")
```

### gfp Old CTX vs SHK
```{r}
compare_matrix_r(gfp.os, gfp.oc, "oSHK", "oCTX")
```


### gfp Old CTX vs Young CTX
```{r}
compare_matrix_r(gfp.oc, gfp.yc, "Old CTX", "Old SHK")
```
### gfp Old SHK Young SHK
```{r}
compare_matrix_r(gfp.ys, gfp.os, "Young SHK", "Old SHK")
```

# NormOL
```{r}
# SUBSET FOR ARC ONLY
nol = sys.weighted %>% filter(CHANNEL=='NormOL')
get_pca(nol, "NormOL")
get_lda(nol, "NormOL")
get_manova(nol)

```

# H2BGFP Heatmap
```{r}

nol.hm = nol %>%
    # mutate(grain2 = paste(CHANNEL, System)) %>%
    ddply(.(CHANNEL, ID), transform, z = scale(weighted)) %>%
    dcast(ID ~ System, value.var="z", fun.aggregate = mean) 
  # ggplot() +aes(as.factor(ID), System, z=z, fill=z) + geom_tile() + rx
# remove spaces? 
  names(nol.hm) = gsub(" ", "_", names(nol.hm))
  names(nol.hm) = gsub("-", ".", names(nol.hm))
  
  # impute missing data
  arc.hm = mice::complete(mice(nol.hm, m=5, seed=25))
rownames(nol.hm) = nol.hm$ID  


heatmap.2(as.matrix(nol.hm[2:length(nol.hm)]), trace="none", hclustfun = hclust,
          col=(brewer.pal(11,"RdBu")),margins=c(10,10), main="NormOL, scaled within animal")
```

### Control
```{r}
nodd = nol %>%
  filter((ID %%2) == T) %>%
  get_corrtest_sys()

neven = nol %>%
  filter((ID%%2) ==F) %>%
  get_corrtest_sys()

compare_matrix_r(nodd, neven, "odd", "even")
```

### NormOL::VALENCE stats 
```{r}

nv1 = nol %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys() 

nv2 = nol %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys() 

compare_matrix_r(nv1, nv2, "context", "shock")

```


### NormOL::EXPT
```{r}

# Get Z dist of CONTEXT
nol.age1 = nol %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys()

nol.age2 = nol %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys()

compare_matrix_r(nol.age1, nol.age2, "young", "old")

```

## NormOL - EXPT:VALENCE
```{r}

nol.ys = nol %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys() 

nol.yc = nol %>%
  filter(EXPT=='YOUNG') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

nol.os = nol %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='SHOCK') %>%
  get_corrtest_sys()

nol.oc = nol %>%
  filter(EXPT=='OLD') %>%
  filter(VALENCE=='CONTEXT') %>%
  get_corrtest_sys()

```


### NormOL Young CTX vs SHK
```{r}

compare_matrix_r(nol.ys, nol.yc, "shock", "context")
```

### NormOL Old CTX vs SHK
```{r}

compare_matrix_r(nol.os, nol.oc, "shock", "context")
```


# GFAP
```{r}

fap = sys.weighted %>% filter(CHANNEL=='H2BGFP') 

get_pca(fap, "GFAP")
```

## CONTROL
```{r}
fapodd = arc %>%
  filter((ID %%2) == T) %>%
  get_corrtest_sys()

fapeven = arc %>%
  filter((ID%%2) ==F) %>%
  get_corrtest_sys()

compare_matrix_r(fapodd, fapeven, "odd", "even")

```

## GFAP - VALENCE
```{r}

fv1 = fap %>%
  filter(VALENCE == 'CONTEXT') %>%
  get_corrtest_sys()

fv2 = fap %>%
  filter(VALENCE == 'SHOCK') %>%
  get_corrtest_sys()

compare_matrix_r(fv1, fv2, "Context", "Shock")


```

## GFAP - EXPT
```{r}

fap.age1 = fap %>%
  filter(EXPT == 'YOUNG') %>%
  get_corrtest_sys() 
fap.age2 = fap %>%
  filter(EXPT == 'OLD') %>%
  get_corrtest_sys() 

compare_matrix_r(fap.age1, fap.age2, "Young", "Old")

```



