---
title: "AGE 10 series - April Explorations"
output:
  html_notebook: default
  html_document: default
  pdf_document: default
---

# 1. Load KK's data

```{r, echo=F,message=FALSE, warning=FALSE}
source("LoadAndProcess.R")

```


# 2. Whole brain (but not really)
- Create table of data to find the mean and SEM for for each: roi, group, age
- Summarize a new table where each obs is an animal with unweighted average density for whole brain 
- Then plot so that each error bar reflects number of animals 

```{r, echo=F,message=FALSE, warning=FALSE}

# # What is the mean count per brain, normalized to area?
# channels.all = names(kk[15:20])

kkl.collapseROI = kk.long %>%
  group_by(CHANNEL, GROUP, VALENCE, CONTEXT, EXPT, ID) %>%
  summarize(sem = std.error(DENSITY), mean_density = mean(DENSITY), N = length(DENSITY),
            ymin = mean_density-sem, ymax = mean_density+sem)
kkl.collapseROI

ggplot(kkl.collapseROI) + aes(GROUP, mean_density, fill=EXPT, color = EXPT) + 
  facet_wrap(~CHANNEL, scales="free") +
  stat_summary(fun.y = mean, geom="point") +
  stat_summary(fun.data = mean_se, geom="linerange") +
  ggtitle("Comparing densities per channel ~ group/age, where n = # animals ")

ggplot(kkl.collapseROI) + aes(VALENCE, mean_density, fill=EXPT, color = EXPT) + facet_wrap(~CHANNEL, scales="free") +
  stat_summary(fun.y = mean, geom="point") +
  stat_summary(fun.data = mean_se, geom="linerange") +
  ggtitle("--> comparing context vs. shock")

ggplot(kkl.collapseROI) + aes(CONTEXT, mean_density, fill=EXPT, color = EXPT) + facet_wrap(~CHANNEL, scales="free") +
  stat_summary(fun.y = mean, geom="point") +
  stat_summary(fun.data = mean_se, geom="linerange") +
  ggtitle("--> comparing A/A vs. A/B")


```


## 2.1 Interpretations of these graphs:
1. DAPI counts are fairly similar between young/age groups, which suggests to me that the counts are somewhat normal, except between AA vs AB in the young animals, which I know are different batches. 
2. Old animals consistently have higher densities, what are possible reasons? 
- Is it because the staining for these animals were done at a later time and were probably better? 
3. How do we know for sure that the young vs. old aren't reflectve of technical artifacts?
- double check that the imaging parameters are the same
- find the mean INTENSITY in each of these groups
- if we only include the brightest z-plane, can we alleviate this?
4. From these graphs it looks like we might not be able to make any real inferences between the old/young animal sets, but what we can do is compare the groups within animal sets, and how those differences compare to each other.
- To do this, we need to normalize the data with the scale() function, but we also need to make sure we scale correctly within each subdivision, and not across the entire variable. 
- 


---

# 3. Which areas are induced by shock? 

```{r, echo=F, fig.width = 16, fig.height = 8, message=FALSE, warning=FALSE}

# library(dplyr)
# 
# shock.induction = ddply(kk.long, .(CHANNEL, BATCH), transform, norm = DENSITY)
# shock.induction = dcast(shock.induction, CHANNEL + SUBROI + EXPT + CONTEXT ~ VALENCE,
#                         value.var = "norm", fun.aggregate = mean)
# colnames(shock.induction)[4] = "CONTEXT2"
# shock.induction$DIFFNORM = shock.induction$SHOCK - shock.induction$CONTEXT
# 
# # make for loop for all
# channels.list = c("DAPI", "H2BGFP", "GFAP", "ArcIHC", "OL", "NormOL")
# 
# for (i in channels.list) {
#   title.paste = paste("Relative shock induction in", i)
#   print(
#     ggplot(shock.induction %>% filter(CHANNEL==i)) + 
#       aes(reorder(SUBROI, DIFFNORM), DIFFNORM) + 
#       stat_summary(fun.y = mean, geom="point") +
#       stat_summary(fun.data = mean_se, geom="linerange") +
#       geom_hline(yintercept = 0) + 
#       ggtitle(title.paste) + 
#       theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#       facet_wrap(~CONTEXT2, ncol=1) +
#       ylab("Shock - context (difference)")
#   )
# }
# 
# 
# aa.induction = ddply(kk.long, .(CHANNEL, SUBROI, BATCH), transform, norm = (DENSITY))
# aa.induction = dcast(aa.induction, CHANNEL + SUBROI + EXPT + VALENCE + ID ~ CONTEXT,
#                      value.var = "norm", fun.aggregate = mean)
# aa.induction$DIFFNORM = aa.induction$AA - aa.induction$AB
# 
# for (i in channels.list) {
#   title.paste = paste("Relative shock induction in", i)
#   print(
#     ggplot(aa.induction %>% filter(CHANNEL==i)) + 
#       aes(reorder(SUBROI, DIFFNORM), DIFFNORM) + 
#       stat_summary(fun.y = mean, geom="point") +
#       stat_summary(fun.data = mean_se, geom="linerange") +
#       geom_hline(yintercept = 0) + 
#       ggtitle(title.paste) + 
#       theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#       facet_wrap(~VALENCE, ncol=2) +
#       ylab("AA-AB (difference)")
#   )
# }
# 
# 

  
  

```


# Density comparisons AA/AB

```{r, fig.width=12, fig.height=12}

ggplot(kk.long %>% filter(EXPT=="_YOUNG")) +
  aes(x=reorder(SUBROI, DENSITY), y=DENSITY, color=CONTEXT) +
  facet_wrap(CHANNEL~VALENCE, ncol=2, scales="free") +
      stat_summary(fun.y = mean, geom="point") +
      stat_summary(fun.data = mean_se, geom="linerange") +
  rx +
  ggtitle("YOUNG ANIMALS")


ggplot(kk.long %>% filter(EXPT=="OLD")) +
  aes(x=reorder(SUBROI, DENSITY), y=DENSITY, color=CONTEXT) +
  facet_wrap(CHANNEL~VALENCE, ncol=2, scales="free") +
      stat_summary(fun.y = mean, geom="point") +
      stat_summary(fun.data = mean_se, geom="linerange") +
  rx +
  ggtitle("OLD ANIMALS")



```

# Density comparisons between young/old

```{r, fig.width=10, fig.height=10}

ggplot(kk.long %>% filter(VALENCE=="SHOCK")) +
  aes(x=reorder(SUBROI, DENSITY), y=DENSITY, color=EXPT) +
  facet_wrap(CHANNEL~CONTEXT, ncol=2, scales="free") +
      stat_summary(fun.y = mean, geom="point") +
      stat_summary(fun.data = mean_se, geom="linerange") +
  rx +
  ggtitle("SHOCK ANIMALS")


ggplot(kk.long %>% filter(VALENCE=="CONTEXT")) +
  aes(x=reorder(SUBROI, DENSITY), y=DENSITY, color=EXPT) +
  facet_wrap(CHANNEL~CONTEXT, ncol=2, scales="free") +
      stat_summary(fun.y = mean, geom="point") +
      stat_summary(fun.data = mean_se, geom="linerange") +
  rx +
  ggtitle("CONTEXT ANIMALS")


```



# t-testing density comparisons

```{r, fig.width=16, fig.height=10}

# comparing AA/AB

library(broom)

t = kk.long %>%
  group_by(EXPT, VALENCE, SUBROI, CHANNEL) %>%
  do(tidy(t.test(data=., DENSITY~CONTEXT)))

ggplot(t) +
  aes(SUBROI, p.value, color=EXPT) +
  geom_point() +
  rx +
  ylim(0, .05) + 
  facet_wrap(VALENCE~CHANNEL, ncol=6) +
  coord_flip()

```

# 4. How about overlap differences in AA vs AB?
- Positive numbers mean more overlap in AA than in AB group, vice versa. 

```{r, echo=F, fig.width = 4, fig.height = 3, message=FALSE, warning=FALSE}

ol.induction = plyr::ddply(kk.long, .(CHANNEL, BATCH), transform, norm = scale(DENSITY))
ol.induction = dcast(ol.induction, CHANNEL + SUBROI + EXPT + VALENCE ~ CONTEXT,
                        value.var = "norm", fun.aggregate = mean)
ol.induction$DIFFNORM = ol.induction$AA - ol.induction$AB

ggplot(ol.induction %>% filter(CHANNEL=="GFAP")) + 
  aes(reorder(SUBROI, DIFFNORM), DIFFNORM, color = EXPT) + 
  stat_summary(fun.y = mean, geom="point") +
  stat_summary(fun.data = mean_se, geom="linerange") +
  geom_hline(yintercept = 0) + 
  #facet_wrap(~EXPT) +
  ggtitle("Relative GFAP induction (in AA vs AB)") +
  theme(axis.text.x = element_text(angle = 90, hjust=1)) +
  facet_wrap(~VALENCE,ncol = 1)

```


# check the straight up intensity levels to find non-transgenics

```{r, fig.width = 6, fig.height = 8}
rx = theme(axis.text.x = element_text(angle = 90, hjust = 1))

raw$ID = as.factor(raw$ID)

ggplot(raw) + aes(reorder(ID, Ch3.Mean.), Ch3.Mean.) + geom_boxplot() +rx + facet_wrap(~Z.Level.) +
  ggtitle("GFAP intensity")

ggplot(raw) + aes(reorder(ID, Ch4.Mean.), Ch4.Mean.) + geom_boxplot() +rx + facet_wrap(~Z.Level.) +
  ggtitle("ArcIHC intensity") 

ggplot(raw) + aes(reorder(ID, Ch2.Mean.), Ch2.Mean.) + geom_violin() +facet_wrap(~Z.Level.) +
  ggtitle("H2B intensity") + coord_flip() + rx + ylim(0,10000)

ggplot(raw) + aes(reorder(ID, Ch1.Mean.), Ch1.Mean.) + geom_violin() +rx + facet_wrap(~Z.Level.) +
  ggtitle("DAPI intensity")

```



