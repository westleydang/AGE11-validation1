---
title: "R Notebook"
output: html_notebook
---

# Inter-regional correlations - TOTAL
Conditions in this set of graphs:
- 1. 'Total' cells only
- 2. Density measures
- 3. Correlations use "complete.obs"
- 4. Ordering by "hclust"
- 5. Removed bad freezers from young group
- 6. Imputed missing values with mean
- 7. All matrices only reflect regions without NA, so each matrix might be a different size

## Update on Jun 9:
All heatmaps have been updated so that p-values matrix have been compared, and all values that are NOT significant have been blanked out as white tiles in the matrix. 

```{r}
source("LoadLibs.R")
library(corrplot)
library(psych)
knew.molten3 = knew.molten2 %>%
  filter(UNITS == "density") %>%
  filter(BRIGHTNESS == 'total')

cluster.method = "alphabet"
use.method = "complete"
corr.type = "pearson"

```

### R vs P values show that R don't always correlate with significance
```{r}

a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)

r.melt = b$r %>% melt()
p.melt = b$p %>% melt()
r.melt = r.melt %>% mutate(p = p.melt$value) %>% filter(p<1 & p>0)
ggplot(r.melt) + aes(value, p) + geom_jitter() +
  ggtitle("OL, Pearson's r vs. p-values (holm-corrected)")

###########################################

a = knew.molten3 %>%
  filter(EXPT=='YOUNG') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)

r.melt = b$r %>% melt()
p.melt = b$p %>% melt()
r.melt = r.melt %>% mutate(p = p.melt$value)  %>% filter(p<1 & p>0)
ggplot(r.melt) + aes(value, p) + geom_point() +
  ggtitle("H2BGFP, Pearson's r vs. p-values (holm-corrected)")

###########################################

a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)

r.melt = b$r %>% melt()
p.melt = b$p %>% melt()
r.melt = r.melt %>% mutate(p = p.melt$value)  %>% filter(p<1 & p>0)
ggplot(r.melt) + aes(value, p) + geom_point() +
  ggtitle("ArcIHC, Pearson's r vs. p-values (holm-corrected)")
```


## Arc - all mice
```{r}
a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all mice, ArcIHC", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### Arc Old vs Young
```{r}

a = knew.molten3 %>%
  filter(EXPT == 'YOUNG') %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all young", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(EXPT == 'OLD') %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all old", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```


### Arc all shock and context animals
```{r}

a = knew.molten3 %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all shock arc", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(VALENCE == 'CONTEXT') %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all context arc", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```


### All animals - compare each group

```{r}

a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 
  

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="shock AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="shock AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="ctx AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'ArcIHC') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)

corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="ctx AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


```

### Compare each subgroup vs. AGE
```{r}
for (expt in unique(knew.molten3$EXPT)) {
  for (ctx in unique(knew.molten3$CONTEXT)) {
    for (val in unique(knew.molten3$VALENCE)) {
        a = knew.molten3 %>%
          filter(CHANNEL == 'ArcIHC') %>%
          filter(EXPT==expt) %>%
          filter(CONTEXT==ctx & VALENCE ==val) %>%
          filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
          mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
          ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
          dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
          mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))  %>%
          select_if(~!all(is.na(.)))
        
        b = corr.test(a[,2:dim(a)[2]])
        corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, 
                 title=paste(val, ctx, expt), 
                 mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")
    }
  }
}
```




## OL 
```{r}
a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all mice, OL", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### Old vs Young
```{r}

a = knew.molten3 %>%
  filter(EXPT == 'YOUNG') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all young", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(EXPT == 'OLD') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all old", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### OL shock vs. context
```{r}

a = knew.molten3 %>%
  filter(CONTEXT == 'AA') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(CONTEXT == 'AB') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

```{r}

a = knew.molten3 %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all shock ol", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(VALENCE == 'CONTEXT') %>%
  filter(CHANNEL == 'OL') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all context ol", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### All animals - Compare each group
```{r}

a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title=" shock AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title=" shock AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title=" ctx AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'OL') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title=" ctx AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### Compare subgroups vs. AGE
```{r}
for (expt in unique(knew.molten3$EXPT)) {
  for (ctx in unique(knew.molten3$CONTEXT)) {
    for (val in unique(knew.molten3$VALENCE)) {
        a = knew.molten3 %>%
          filter(CHANNEL == 'OL') %>%
          filter(EXPT==expt) %>%
          filter(CONTEXT==ctx & VALENCE ==val) %>%
          filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
          mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
          ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
          dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
          mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))  %>%
          select_if(~!all(is.na(.)))
        
        b = corr.test(a[,2:dim(a)[2]])
        corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, 
                 title=paste(val, ctx, expt), 
                 mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")
    }
  }
}
```


## H2BGFP
```{r}
a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all mice, H2BGFP", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### H2B old vs Young
```{r}

a = knew.molten3 %>%
  filter(EXPT == 'YOUNG') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all young", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

a = knew.molten3 %>%
  filter(EXPT == 'OLD') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all old", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```


### H2B shock vs context
```{r}

a = knew.molten3 %>%
  filter(VALENCE == 'SHOCK') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all shock h2b", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

corrplot(b$p, method="color", order=cluster.method, tl.cex=0.4, title="p-values, all shock h2b", mar=c(0,0,1,0), is.corr=F)

a = knew.molten3 %>%
  filter(VALENCE == 'CONTEXT') %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use="complete")
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="all context h2b", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```
### All animals - Compare each group
```{r}

a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AA' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="shock AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AB' & VALENCE =='SHOCK') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="shock AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AA' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="ctx AA", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")


a = knew.molten3 %>%
  filter(CHANNEL == 'H2BGFP') %>%
  filter(CONTEXT=='AB' & VALENCE =='CONTEXT') %>%
  filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
  mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
  ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
  dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .))) 

b = corr.test(a[,2:67], use=use.method)
corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, title="ctx AB", mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")

```

### Compare subgroup vs. AGE
```{r}
for (expt in unique(knew.molten3$EXPT)) {
  for (ctx in unique(knew.molten3$CONTEXT)) {
    for (val in unique(knew.molten3$VALENCE)) {
        a = knew.molten3 %>%
          filter(CHANNEL == 'H2BGFP') %>%
          filter(EXPT==expt) %>%
          filter(CONTEXT==ctx & VALENCE ==val) %>%
          filter(!(EXPT =='YOUNG' & VALENCE=='SHOCK' & CONTEXT=='AA' & FREEZE < 30)) %>% # removes young bad freezers
          mutate(grain2 = paste(CHANNEL, SubROI_SubroiAGGR)) %>%
          ddply(.(CHANNEL, SubROI_SubroiAGGR), transform, z = scale(value)) %>%
          dcast(ID ~ grain2, value.var="z", fun.aggregate = mean)  %>%
          mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE), .)))  %>%
          select_if(~!all(is.na(.)))
        
        b = corr.test(a[,2:dim(a)[2]])
        corrplot(b$r, method="color", order=cluster.method, tl.cex=0.4, 
                 title=paste(val, ctx, expt), 
                 mar=c(0,0,1,0), p.mat=b$p, sig.level=0.05, insig="blank")
    }
  }
}
```

