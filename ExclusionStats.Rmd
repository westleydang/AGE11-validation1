---
title: "Exclusions stats"
output: html_notebook
---

# Show the exclusions statistics

## Load the data first
- Load the exclusion files, then find how many of them were rotated

```{r load_ex_files}

# Need to load the RAW data files processor first

# MAKE LIST OF FILES
# READ EXCLUSION FILES
excluded.files = ex

# GSUB THE DIMENSIONS
excluded.files$Width = gsub("\\?", "", excluded.files$Width)
excluded.files$Height = gsub("\\?", "", excluded.files$Height)
excluded.files$Width = gsub(" pixels", "", excluded.files$Width)
excluded.files$Height = gsub(" pixels", "", excluded.files$Height)
excluded.files$Width = as.numeric(excluded.files$Width)
excluded.files$Height = as.numeric(excluded.files$Height)

# NEW VARIABLE TO TELL IF ROTATED

library(dplyr)
library(plyr)
excluded.files = excluded.files %>%
  mutate(
    rotated = ifelse(Width < Height, 1, 0)
  )

# AVERAGE TOTAL ROTATED
mean(excluded.files$rotated)



```

## Plot how many excluded
For some reason the 10-A groups had less exclusion...

```{r plot, echo=FALSE}

# PERCENT EXCLUDED PER ANALYSIS ROUND
recovery.stats = excluded.files %>% 
  group_by(round) %>%
  summarize(num.excluded = length(rotated[rotated=='1']),
            total = length(round),
            pct.excluded = 100*mean(rotated))

recovery.stats %>%
  ggplot() + aes(round, pct.excluded) + geom_bar(stat="identity") + 
  coord_flip() + ylim(0,100) + 
  ggtitle("Percent excluded per dataset segment") + 
  theme_minimal() 



```



# Import revisions files then compare exclusion vs. recovery
- For some reason something is up with 10-B R2, it has more recovered than excluded
-- could it be because the exclusion file is the correct one? 
- 10B R1, 10A R2 have very low recovered
-- could it be because the recovery macro didn't detect the file name discrepancies?
```{r}
# NOTE: REV FILES IMPORTED FROM THE RAW PROCESSING STEP
# LOAD DATA WITH 'LOADPROCESSRAW-MAY2018.R' FIRST
# Should have a dataframe called 'rev' now

recovery.stats = recovery.stats %>%
  group_by(round) %>%
  mutate(
    round_stem = sub(" - .*", "", unique(round))
  )

# create stem of rounds to merge recovery + exclusions
revision.filestats = rev %>%
  group_by(round) %>%
  summarize(num.revised = length(unique(File.Name.))) %>%
  mutate(round_stem = sub(" - .*", "", unique(round)))

recovery.stats = merge(recovery.stats, revision.filestats[,2:3], by="round_stem")

# calculate the percent recovered
recovery.stats = recovery.stats %>%
  mutate(pct.recovered.from.excluded = 100*num.revised/num.excluded,
         pct.recovered.from.total = 100*num.revised/total)

recovery.stats = recovery.stats %>%
  mutate(data.used = (100-pct.excluded)+(pct.recovered.from.total))


```


# Plotting the graphs


```{r, fig.height=3, fig.width=3}

# plot percent recovered vs total
recovery.stats %>%
  ggplot() + aes(round_stem, pct.recovered.from.total, label=round(pct.recovered.from.total,1)) + 
  geom_bar(stat="identity") + 
  coord_flip() + ylim(0,100) + 
  ggtitle("Percent recovered from total dataset") +
  geom_label() + theme_minimal()

# plot percent recovered vs excluded
recovery.stats %>%
  ggplot() + aes(round_stem, pct.recovered.from.excluded, label=round(pct.recovered.from.excluded,1)) + 
  geom_bar(stat="identity") + 
  coord_flip() + ylim(0,100) + 
  ggtitle("Percent recovered from the excluded subset") +
  geom_label() + theme_minimal()

# plot the recovery and exclusions
recovery.stats %>%
  select(round_stem, pct.excluded, pct.recovered.from.total) %>%
  melt() %>%
  ggplot() + aes(round_stem, value, fill=variable) + 
  geom_bar(stat="identity", position="dodge") +
  coord_flip() + ylim(0,100) +
  ggtitle("Percent data excluded vs. percent recovered") +
  xlab("Data analysis segment") + ylab("Percent data excluded/revised") +
  theme_minimal()


# plot the data actually used
recovery.stats %>%
  ggplot() + aes(round_stem, data.used, label=round(data.used,1), fill=data.used) + geom_bar(stat="identity") +
  coord_flip() + ggtitle("Percent data used from each dataset segment") +
  theme_minimal() + 
  xlab("Data analysis segment") + ylab("Percent data used in the end")

```


