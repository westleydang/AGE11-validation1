---
title: "R Notebook"
output:
  html_notebook: default
  html_document: default
  pdf_document: default
---

# Group Legends
- SAB - shock AB
- SAA - shock AA
- CAB - context AB
- CAA - context AA

# Channel Legend
- Ch 1 = DAPI (stained)
- Ch 2 = GFP (experience 1)
- Ch 3 = GFAP (stained)
- Ch 4 = ARC (experience 2; stained)
- OL = overlap GFP/Arc
- OL.norm = overlap normalized to GFP/Arc

# EXPT legends
- AGE 10 = young mice
- AGE 11 = old mice


# Prepare the data
- loads the libraries
- loads the data (as kk)
- merges in the animal details
- creates a normalized measure of OL counts
- transforms a long format version of data (kk.long)
```{r, message=FALSE, warning=FALSE}
# Load libraries
library(ggplot2)
library(reshape2)
library(dplyr)
library(plotrix)
library(GGally)



# Load the data
kk = read.csv(file="All AGE 10 series counts-03232018/Wes_SUBROI_CLN_STACKED.csv", header=TRUE, sep=",")
kk$idBysubroi = as.factor(kk$idBysubroi)


# Merge animal details
animal_details = read.csv("animal_details.csv")
animal_details$Mouse.ID. = as.factor(animal_details$ID)
colnames(animal_details)[9] = "idBysubroi"
kk = merge(animal_details, kk, by = "idBysubroi")
colnames(kk)[2] = "GROUP"


# Merge gruop details
group_details = read.csv("group_details.csv")
names(group_details)[1] = "GROUP"
kk = merge(group_details, kk, by="GROUP")

attach(kk)

# normalize the OL counts
kk$OLmm2.norm = kk$OLmm2
kk$OLmm2.norm = kk$OLmm2/(kk$Ch2mm2 + kk$Ch4mm2 - kk$OLmm2)


# Transform rawkk to a long format
kk.long = melt(kk, id.vars=names(kk[1:14]), variable.name = "CHANNEL", value.name="DENSITY")


```


# Create table of data to find the mean and SEM for for each: roi, group, age
- Summarize a new table where each obs is an animal with unweighted average density for whole brain 
- Then plot so that each error bar reflects number of animals 
```{r, message=FALSE, warning=FALSE}

# 
# # What is the mean count per brain, normalized to area?
# channels.all = names(kk[15:20])

kkl.collapseROI = kk.long %>%
  group_by(CHANNEL, GROUP, VALENCE, CONTEXT, EXPT, ID) %>%
  summarize(sem = std.error(DENSITY), mean_density = mean(DENSITY), N = length(DENSITY),
            ymin = mean_density-sem, ymax = mean_density+sem)
kkl.collapseROI

ggplot(kkl.collapseROI) + aes(GROUP, mean_density, fill=EXPT, color = EXPT) + facet_wrap(~CHANNEL, scales="free") +
  stat_summary(fun.y = mean, geom="point") +
  stat_summary(fun.data = mean_se, geom="linerange") +
  ggtitle("Comparing densities per channel ~ group/age, where n = # animals ")


```



# Look means at each SUBROI
- not sure where these SEMs are correct
```{r, fig.width=24, fig.height=32, message=FALSE, warning=FALSE}
# for (i in channels.all) {
#   print (
#     ggplot(rawkk) + aes(factor(SUBROI), rawkk[i], fill=EXPT, color=EXPT) + 
#       stat_summary(fun.y = mean, 
#                    position="dodge",
#                    geom="point") +
#       stat_summary(fun.data = mean_se, 
#                    size=.5,
#                    position="dodge",
#                    geom="linerange") +
#       ggtitle(i) + coord_flip() 
#   )
# }


kkl.collapseID = kk.long %>% 
  group_by(CHANNEL, GROUP, EXPT, SUBROI, ID) %>%
    summarize(sem = std.error(DENSITY), mean_density = mean(DENSITY), N = length(DENSITY),
            ymin = mean_density-sem, ymax = mean_density+sem)
kkl.collapseID


ggplot(kkl.collapseID) + aes(SUBROI, mean_density, fill=EXPT, color=EXPT) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.data = mean_se, size=0.5, geom="linerange") +
  coord_flip() + facet_wrap(GROUP~CHANNEL, ncol=6, scales="free")


ggplot(filter(kk.long, kk.long$CHANNEL=="OLmm2.norm")) + aes(SUBROI, DENSITY, fill=EXPT, color=EXPT) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.data = mean_se, size=0.5, geom="linerange") +
  ggtitle("OLmm2 normalized to Arc and GFP") + coord_flip()


```


# I'm interested to know how the individual counts relate to the OL
- Let's do a linear regression matrix

```{r, echo=FALSE, warning=FALSE, message=FALSE}


# Relative channel correlations
ggpairs(kk[,15:20], progress=FALSE) + 
  ggtitle("How do the channels relate to each other?")


# Make a loop to print out all those correlation graphs
for (temp.age in factor(levels(kk$EXPT))) {
  for (temp.grp in factor(levels(kk$GROUP))) {
  # subset the data in intermediate set
    title = paste("How do the channels relate to each other? -->", temp.grp, temp.age)
    kk.temp = kk %>% filter(GROUP == temp.grp) %>% filter (EXPT == temp.age)

    # then print the pairs and corrs without the progress
    print(ggpairs(kk.temp[,15:20], label=T) + ggtitle(title), progress=F)
    print(ggcorr(kk.temp[,15:20], label=T) + ggtitle(title), progress=F)
  }
}


# 
#     
# makePlot = function(x) {
#   titleF = paste("How do the channels relate to each other? -->", x)
#   kk.temp = kk %>% filter(GROUP==x)
#   p = ggcorr(kk.temp[,15:20], label=TRUE, size=3) + labs(title = "Points Per Game")
#   return(p) 
# }
# 
# l = lapply(levels(kk$GROUP), makePlot)
# ggmatrix(l, 2, 2, c("A", "B"), c("C", "D"))
# 
# 
# 


# What about per age?
# set = kk %>% filter(EXPT=="AGE 10")
# ggpairs(set[,15:20]) + 
#   ggtitle("How do the channels relate to each other? (YOUNG only)")
# ggcorr(set[,15:20], label = TRUE) + ggtitle("How do the channels relate to each other? (YOUNG only)")
# 
# set = kk %>% filter(EXPT=="AGE 11")
# ggpairs(set[,15:20]) + 
#   ggtitle("How do the channels relate to each other? (OLD only)")
# ggcorr(set[,15:20], label = TRUE) + ggtitle("How do the channels relate to each other? (OLD only)")


# 
# 
# # How does the OL vary with the normalized OL?
# 
# ggplot(kk) + aes(x=OLmm2, y=OLmm2.norm) +
#   geom_smooth(method='lm', formula=y~x) + 
#   ggtitle("How does OL affect OL normalized?") +
#   labs(x = "Overlap density", y = "Normalized overlap") +
#     stat_poly_eq(formula = y~x, 
#                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                parse = TRUE)
# 


```




# For loop for each ROI
- Make a graph and the data table separately

```{r, eval=FALSE}
for (k in channels.all) {
  
  for (roi in interesting.ROI) {
    
    df = rawkk[rawkk$SUBROI %in% list(roi),]
    
    # Make pointrange graphs 
    print(
      ggplot(df) +
      aes(x=GROUP, y=df[,k], fill=EXPT, shape=EXPT, color=EXPT) +
      stat_summary(fun.y = mean, 
                   geom="point") +
      stat_summary(fun.data=mean_se, 
                   geom="pointrange") +
      facet_wrap(~SUBROI) + 
        labs(y = as.character(k)) + 
        ggtitle(paste0(roi, " for channel ", k))
    )
    
    
    
  #   
  #   # let's check if we can summarize the table by dplyr
  #   print(
  #     rawkk[rawkk$SUBROI==roi,] %>% 
  #       group_by(GROUP, EXPT) %>%
  #       summarize_if(is.numeric, mean)
  #   )
  #   print(
  #     rawkk[rawkk$SUBROI==roi,] %>% 
  #       group_by(GROUP, EXPT) %>% 
  #       summarize_if(is.numeric, std.error)
  #   )
  }
}


```


# Which ROI are most reliable? Areamm2 by ROI
- I'd say biggest ROI are most reliable
```{r,fig.width=6,fig.height=8 }

ggplot(kk) + aes(x=reorder(SUBROI, AREAmm2), AREAmm2) + coord_flip() +
  stat_summary(fun.y = mean, geom="point") + 
  ggtitle("ROI Area measured as proxy for reliability")

```




